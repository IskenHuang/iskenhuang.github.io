<!doctype html>
<html class="no-js" lang="EN-US" style="max-width: initial;">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>CSV table tool</title>
        <meta name="description" content="demo, testing and blog">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="og:url"           content="https://isken.me" />
        <meta property="og:type"          content="website" />
        <meta property="og:title"         content="Isken Huang's Lab" />
        <meta property="og:description"   content="demo, testing and blog" />
        <meta property="og:image"         content="https://isken.me/me.jpg" />
        <link rel="icon" href="/favicon.ico?v=1.1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <link rel="stylesheet" href="/common.min.css">
        <!-- Place favicon.ico in the root directory -->
        <style>
            thead {
                position: sticky;
                top: 0;
                background-color: var(--color-bg);
            }
        </style>
    </head>
    <body>
        <h1>CSV table tool</h1>
        <div><input type="file" onchange="changeFile(this)"/><input type="text" onkeyup="searchRow(this)" placeholder="Search rows" /></div>
        <table></table>
        <script>
            /* cav parser */
            function parseToArray(e,n){n=n||",";const r=new RegExp("(\\"+n+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+n+"\\r\\n]*))","gi"),t=[[]];let l=null;for(;l=r.exec(e);){const e=l[1];let r;e.length&&e!==n&&t.push([]),r=l[2]?l[2].replace(new RegExp('""',"g"),'"'):l[3],t[t.length-1].push(r)}return t}

            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        initCell(entry.target)
                        observer.unobserve(entry.target)
                    } else {
                        // Element is no longer visible
                    }
                })
            })
            
            const $table = document.querySelector('table')
            window.changeFile = async (e) => {
                console.log('e = ', e)
                const file = e.files[0]
                const fileStr = await file.text()
                const csvData = parseToArray(fileStr)
                
                const csvBody = csvData.slice(1)
                const $thead = document.createElement('thead')
                const $theadTr = document.createElement('tr')
                csvData[0].forEach(v => {
                    const $td = createTd(v)
                    $theadTr.append($td)
                    observer.observe($td)
                })
                $thead.append($theadTr)
                $table.append($thead)
                
                const $tbody = document.createElement('tbody')
                csvData.slice(1).forEach(row => {
                    const $tr = document.createElement('tr')
                    row.forEach(v => {
                        const $td = createTd(v)
                        $tr.append($td)
                        observer.observe($td)
                    })
                    $tbody.append($tr)
                })
                $table.append($tbody)

            }
            window.initCell = (el) => {
                const state = el.getAttribute('init')
                if (state === 'false') {
                    const v = el.textContent
                    try {
                        const urlObj = new URL(v)
                        const $a = document.createElement('a')
                        $a.setAttribute('href', v)
                        $a.setAttribute('alt', v)
                        $a.setAttribute('target', '_blank')
                        const isImg = urlObj.pathname.match(/\.(gif|jpg|jpeg|png|bmp|avif|hevc)/)
                        if (isImg) {

                            const $img = document.createElement('img')
                            $img.setAttribute('src', v)
                            $img.setAttribute('alt', v)
                            $img.setAttribute('width', '300px')
                            $img.setAttribute('height', '300px')
                            $a.append($img)
                        }
                        el.innerHTML = $a.outerHTML
                    } catch(e) {}
                    el.setAttribute('init', true)
                }
                
            }

            window.searchRow = (el) => {
                const val = el.value || ''
                const regex = new RegExp(val, 'i')
                $table.querySelectorAll('tbody > tr').forEach($el => {
                    const isMatch = $el.textContent.match(regex)
                    if (isMatch) {
                        $el.style.display = ''
                    } else {
                        $el.style.display = 'none'
                    }
                })
                debugger
            }

            function createTd(v) {
                const $td = document.createElement('td')
                $td.textContent = v
                $td.setAttribute('init', false)
                return $td
            }

        </script>
        <script>if (navigator.serviceWorker) { navigator.serviceWorker.register('/sw.js') }</script>
    </body>
</html>
