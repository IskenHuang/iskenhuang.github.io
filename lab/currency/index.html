<!doctype html>
<html class="no-js" lang="EN-US">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Currency</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="og:url"           content="https://isken.me" />
        <meta property="og:type"          content="website" />
        <meta property="og:title"         content="Isken Huang's Lab" />
        <meta property="og:description"   content="demo, testing and blog" />
        <meta property="og:image"         content="https://isken.me/me.jpg" />
        <link rel="icon" href="/favicon.ico?v=1.1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <link rel="stylesheet" href="/common.min.css">
        <!-- Place favicon.ico in the root directory -->
        <style>
            input, label {
                display: inline-block;
            }
            label {
                width: 46px;
            }
            input {
                width: calc(100% - 4.6rem);
            }
        </style>
    </head>
    <body>
        <div>
            <h1 onclick="init()">Currency</h1>
            <div class="js-main"></div>
            <span>Currency data from <a href="https://exchangerate.host" target="_blank">https://exchangerate.host</a></span>
        </div>

        <script type="text/javascript">
            ;(function() {
                const $main = document.querySelector('.js-main'),
                    currencyList = {
                        USD: {
                            isSelected: true
                        },
                        TWD: {
                            isSelected: false,
                        },
                        CNY: {
                            isSelected: false,
                        },
                        JPY: {
                            isSelected: false,
                        },
                        HKD: {
                            isSelected: false,
                        },
                        SGD: {
                            isSelected: false,
                        },
                    }

                window.changeValue = function (e) {
                    updateUI(e.value)
                }
                window.clickValue = function(e) {
                    const selectCurrency = e.getAttribute('currency')
                    for (let i in currencyList) {
                        const c = currencyList[i]
                        if (i === selectCurrency) {
                            c.isSelected = true
                        } else {
                            c.isSelected = false
                        }
                    }
                    getCurrency(selectCurrency).then( res => updateUI(e.value))
                }

                window.init = function init() {
                    getCurrency().then(() => {
                        $main.innerHTML = ''
                        for (let i in currencyList) {
                            $main.innerHTML += generateCurrency({
                                name: i,
                                value: 0,
                            })
                        }
                        return true
                    }).then( res => updateUI(100))
                }


                init()

                function generateCurrency(obj) {
                    const _obj = Object.assign({}, obj)
                    const name = obj.name || ''
                    const value = obj.value || '0'
                    return `
                        <label>${name}</label>
                        <input
                            currency="${name}"
                            type="number"
                            class="js-currency"
                            placeholder="0.00"
                            value="${value}"
                            onChange="changeValue(this)"
                            onClick="clickValue(this)"
                            />
                    `
                }

                function getCurrency(main) {
                    // console.log('getCurrency = ', main)
                    main = main || 'USD'
                    other = Object.keys(currencyList)

                    const c = getCurrencySelected()
                    if (c && c.rates) {
                        // console.log('c = ', c)
                        return Promise.resolve(c.rates)
                    }

                    return fetch(`https://api.exchangerate.host/latest?base=${main}&symbols=${other.join(',')}`)
                        .then(res => res.json())
                        .then(res => {
                            // console.log('res = ', res)
                            if (res.success) {
                                for (let i in currencyList) {
                                    const item = currencyList[i]
                                    if (i === main) {
                                        currencyList[i].rates = res.rates
                                    }
                                }
                                return res.rates
                            } else {
                                return {}
                            }
                            return res
                        })
                        .catch(e => {
                            console.log('err = ', e)
                            return {}
                        })
                }

                function getCurrencySelected() {
                    for (let i in currencyList) {
                        const item = currencyList[i]
                        if (item.isSelected) {
                            return item
                        }
                    }
                    return null
                }

                function updateUI(newValue) {
                    const $inputs = $main.querySelectorAll('input')
                    const { rates } = getCurrencySelected()

                    $inputs.forEach((el, index) => {
                        const name = el.getAttribute('currency')
                        el.value = ((newValue) * (rates[name] || 0)).toFixed(2)
                    })
                }
            })();
        </script>


        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='https://www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-3392989-7','auto');ga('send','pageview');
        </script>
    </body>
</html>
